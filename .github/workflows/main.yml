# 工作流名称：1.更新调度（定时+手动触发）
name: '1.Update schedule'

on:
  schedule:
    # 每2天UTC时间22:00执行（对应上海时间次日6:00）
    # cron 格式：分 时 日 月 周，*/2 表示每2天
    - cron: '0 22 */2 * *'  
  workflow_dispatch:  # 允许手动触发（支持在GitHub页面手动点击运行）
env:
  TZ: Asia/Shanghai  # 设置时区为上海

jobs:
  push:
    runs-on: ubuntu-latest  # 直接指定运行环境，移除冗余的矩阵配置
    steps:
      # 步骤1名称：设置分支名称（根据仓库所有者自动切换gd/master分支）
      - name: Set branch name(设置分支名称)
        id: vars
        run: echo "BRANCH_NAME=${{ github.repository_owner == 'Guovin' && 'gd' || 'master' }}" >> $GITHUB_ENV
        continue-on-error: false  # 分支名称设置失败则终止流程，避免后续无效操作

      # 步骤2名称：检出代码（拉取对应分支的仓库代码到运行环境）
      - name: Checkout code(检出代码)
        uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH_NAME }}  # 检出自动切换后的分支
        continue-on-error: false

      # 步骤3名称：配置Python 3.13环境（搭建项目所需的Python运行环境，开启缓存优化2
      - name: Setup Python 3.13(配置Python 3.13环境)
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          update-environment: true
          cache: 'pipenv'  # 缓存pipenv依赖，提升后续执行速度
        continue-on-error: false

      # 步骤4名称：安装FFmpeg（安装音视频处理工具，满足项目可能的音视频操作需求）
      - name: Install FFmpeg(安装FFmpeg)
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
        continue-on-error: false

      # 步骤5名称：安装pipenv（安装Python虚拟环境和依赖管理工具pipenv）
      - name: Install pipenv(安装pipenv工具)
        run: pip3 install --user pipenv
        continue-on-error: false

      # 步骤6名称：安装项目依赖（基于pipenv创建虚拟环境并部署项目所需依赖）
      - name: Install dependencies(安装项目依赖)
        run: pipenv --python 3.13 && pipenv install --deploy
        continue-on-error: false

      # 步骤7名称：执行更新命令（运行项目的dev脚本，完成核心更新逻辑）
      - name: Run update command(执行更新命令)
        run: pipenv run dev
        continue-on-error: false

      # 步骤8名称：提交并推送变更（如有变更，自动提交并推送至远程分支）
      - name: Commit and push changes (if any)(提交并推送变更)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          # 仅当有暂存变更时才提交和推送
          if ! git diff --staged --quiet; then
            git commit -m "Github Action Auto Updated"
            # 新增：先拉取远程最新变更（变基方式，保持提交历史整洁），解决本地落后远程的推送拒绝问题
            git pull --rebase origin ${{ env.BRANCH_NAME }}
            # 再推送整合后的变更
            git push
          fi
        continue-on-error: true  # 推送失败不终止后续清理步骤

      # 步骤9名称：清理旧的Workflow运行记录（清理冗余运行记录，仅保留最近5条）
      - name: Clear the old Workflow run records(清理旧的Workflow运行记录)
        if: always()  # 无论前面步骤成功与否，都执行清理
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          keep_minimum_runs: 5  # 保留最近5条运行记录
          retain_days: 0        # 不按天数保留，仅按最小运行记录数保留
          ignore_error: true    # 忽略清理过程中的错误，避免影响工作流整体状态
